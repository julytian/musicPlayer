<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link rel="Shortcut Icon" href="favicon.ico">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>网易云音乐</title>
    <script src="js/jquery.min.js"></script>
    <script src="js/APlayer.min.js"></script>
    <script src="js/vue.js"></script>
    <script src="js/vue-resource.js"></script>
</head>

<body>
    <div id="app">
        <input type="text" v-model="search">
        <button @click="searchMusic">搜索</button>
        <div id="player1" class="aplayer"></div>
    </div>
    <script>
    function formatterDateTime() {
        var date = new Date()
        var month = date.getMonth() + 1
        var datetime = date.getFullYear() + "" // "年"
            + (month >= 10 ? month : "0" + month) + "" // "月"
            + (date.getDate() < 10 ? "0" + date.getDate() : date
                .getDate()) + "" + (date.getHours() < 10 ? "0" + date.getHours() : date
                .getHours()) + "" + (date.getMinutes() < 10 ? "0" + date.getMinutes() : date
                .getMinutes()) + "" + (date.getSeconds() < 10 ? "0" + date.getSeconds() : date
                .getSeconds());
        return datetime;
    }

    new Vue({
        el: '#app',
        data: {
            search: '',
            music: [],
            ap: null,
        },
        methods: {
            searchMusic: function() {
                if (this.ap) {
                    this.ap.pause();
                }
                var that = this;
                var time = formatterDateTime();
                var searchUrl = 'http://route.showapi.com/213-1?keyword=' + this.search;
                var showapi_appid = '23654';
                var  showapi_sign = "d23793312daf46ad88a06294772b7aac";
                $.ajax({
                    type: 'post',
                    url: searchUrl,
                    dataType: 'jsonp',
                    data: {
                        "showapi_timestamp": formatterDateTime(),
                        "showapi_appid": showapi_appid, //这里需要改成自己的appid
                        "showapi_sign": showapi_sign //这里需要改成自己的密钥
                    },
                    jsonp: 'jsonpcallback',
                    error: function(XmlHttpRequest, textStatus, errorThrown) {
                        console.log("操作失败!");
                    },
                    success: function(response) {
                        var result = response.showapi_res_body.pagebean.contentlist;
                        var songUrl = [];
                        result.map(function(item, i) {
                            var index  = i;
                            var songId = item.songid;
                            var title  = item.songname;
                            var author = item.singername;
                            var url    = item.m4a;
                            var pic    = item.albumpic_big;
                            songUrl.push('http://route.showapi.com/213-2?musicid=' + songId);
                            that.music.push({
                                title: title,
                                author: author,
                                url: url,
                                pic: pic,
                                lrc: '[00:00.00]'
                            });
                        });


                        songUrl.map(function(item, i) {
                            $.ajax({
                                type: 'get',
                                url: songUrl[i],
                                data: {
                                    "showapi_timestamp": formatterDateTime(),
                                    "showapi_appid": showapi_appid, //这里需要改成自己的appid
                                    "showapi_sign": showapi_sign//这里需要改成自己的密钥
                                },
                                error: function(XmlHttpRequest, textStatus, errorThrown) {
                                    console.log("操作失败!");
                                },
                                success: function(response) {
                                    var body = response.showapi_res_body;
                                    console.log(i+":")
                                    console.log(body.lyric?body.lyric: 'null')
                                    if(body.lyric){
                                        that.music[i].lrc = body.lyric
                                    }else{
                                        that.music[i].lrc = "[00:00.00]" ;
                                    }

                                    if (i == 5 ) {
                                        that.ap = new APlayer({
                                            element: document.getElementById('player1'),
                                            narrow: false,
                                            autoplay: true,
                                            showlrc: 1,
                                            mutex: true,
                                            theme: '#615754',
                                            music: that.music
                                        });

                                        that.ap.init();
                                        that.search = '';
                                        that.music = [];
                                    }
                                }

                            });

                        });

                    }

                });
            }
        }
    })
    </script>
</body>

</html>
